#########################################   multiqc.smk   ############################################################################
#
#   Description:
#       This Snakemake pipeline generates a comprehensive MultiQC report by aggregating quality control (QC) 
#       results from various upstream processes. The script consolidates data from trimmed read QC, host genome alignment QC, 
#       pathogen alignment QC, and Kraken screening results into a single, easy-to-navigate HTML report. 
#       This unified report provides an overview of the pipeline's performance and key statistics at different stages.
#
#   Inputs:
#       - Trimmed read QC data: FastQC reports for quality assessment of adapter-trimmed reads.
#       - Host genome alignment QC data: Qualimap reports for host genome mapping quality.
#       - Pathogen genome alignment QC data: Qualimap reports for pathogen genome mapping quality.
#       - Kraken QC data: Kraken2 taxonomic classification reports detailing microbial composition.
#
#    Outputs:
#       - MultiQC combined report: A single HTML report consolidating statistics and visualizations for all input QC data.
#
#   Tools used:
#       - MultiQC: A tool for creating aggregated QC reports from output generated by various bioinformatics tools.
#
#   Statistical plots provided by MultiQC output:
#       - For trimmed read QC (FastQC):
#           - Per-base sequence quality
#           - Per-sequence GC content
#           - Adapter content and sequence duplication levels
#       - For host and pathogen alignment QC (Qualimap):
#           - Mapping percentage and coverage statistics
#           - Insert size distributions
#           - Read alignment quality and distribution metrics
#       - For Kraken QC:
#           - Total number of classified and unclassified reads
#           - Taxonomic composition of reads (percentage and counts per taxonomic group)
#           - Detailed lineage breakdown for detected microbial species
#
#   Usage:
#       This script is used to summarize key QC metrics from multiple tools into a single report, providing a clear overview 
#       of the pipeline's upstream processes, including trimming, alignment, and taxonomic classification. 
#       The combined report is useful for identifying trends, outliers, or issues across multiple samples.
#
###############################################################################################################################################################


TRIMMED_QC_DIR = "output/qc/trimmed"  # Trimmed read QC data
HOST_QC_DIR = "output/alignment_qc/host"  # Host alignment QC data
PATHOGEN_QC_DIR = "output/alignment_qc/pathogen"  # Pathogen alignment QC data
KRAKEN_QC_DIR = "output/bacterial_screening/kraken"  # Kraken results

# Rule: Generate a MultiQC report from multiple QC folders
rule multiqc_combined_report:
    
    input:
        trimmed_qc=TRIMMED_QC_DIR,
        host_qc=HOST_QC_DIR,
        pathogen_qc=PATHOGEN_QC_DIR,
        kraken_qc=KRAKEN_QC_DIR
    
    output:
        report="output/multiqc/multiqc_combined_report.html"
    
    log:
        "logs/multiqc/multiqc_combined_report.log"
    
    conda:
        "environments/multiqc.yaml"  
    
    shell:
        """
        multiqc {input.trimmed_qc} {input.host_qc} {input.pathogen_qc} {input.kraken_qc} -o {output.report} > {log} 2>&1
        """
